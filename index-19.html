<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>×§××¨×¤×•×œ ×›×“×•×¨×¡×œ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #2a2a2a; min-height: 100vh; display: flex; justify-content: center; padding: 3px; }

    .login-screen { background: white; border-radius: 15px; padding: 30px 25px; width: 90vw; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: center; }
    .login-screen h1 { font-size: 22px; color: #333; margin-bottom: 10px; text-align: center; }
    .login-screen .subtitle { font-size: 14px; color: #666; margin-bottom: 25px; text-align: center; }
    .form-group { width: 100%; margin-bottom: 18px; }
    .form-group label { display: block; font-size: 14px; font-weight: bold; color: #333; margin-bottom: 8px; }
    .form-group input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; font-family: Arial, sans-serif; }
    .form-group input:focus { outline: none; border-color: #4A90E2; }

    .login-btn { width: 100%; padding: 14px; background: #4A90E2; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
    .login-btn:hover { background: #357ABD; }
    .login-btn:disabled { background: #ccc; cursor: not-allowed; }

    .error-msg { color: #D0021B; font-size: 13px; margin-top: 10px; text-align: center; display: none; }
    .error-msg.show { display: block; }

    .container { background: white; border-radius: 10px; padding: 6px; width: 99vw; max-width: 600px; display: none; }
    .container.active { display: block; }

    h1 { text-align: center; color: #333; margin-bottom: 3px; font-size: 12px; font-weight: bold; }

    .top-actions { display:flex; justify-content:center; gap:8px; margin: 6px 0 6px 0; }
    .save-btn { padding: 8px 14px; border: none; border-radius: 6px; background: #10b981; color: white; font-weight: bold; cursor:pointer; font-size: 12px; }
    .save-btn:disabled { background:#9ca3af; cursor:not-allowed; }
    .dirty-indicator { font-size: 11px; color:#666; align-self:center; }

    .legend { display: flex; justify-content: center; gap: 5px; margin-bottom: 3px; padding: 3px; background: #f5f5f5; border-radius: 4px; }
    .legend-item { display: flex; align-items: center; gap: 2px; font-size: 8px; font-weight: bold; }
    .color-dot { width: 9px; height: 9px; border-radius: 50%; border: 1px solid #ddd; }
    .color-dot.blue { background: #5BC0DE; }
    .color-dot.green { background: #8BC34A; }
    .color-dot.orange { background: #E91E90; }
    .color-dot.red { background: #9C27B0; }

    .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; padding: 3px; background: #f5f5f5; border-radius: 4px; }
    .week-nav button { padding: 3px 8px; border: none; border-radius: 3px; background: #555; color: white; font-size: 8px; font-weight: bold; cursor: pointer; }
    .week-title { font-size: 9px; font-weight: bold; color: #333; }

    .schedule-table { border-collapse: collapse; font-size: 11px; width: 100%; margin-bottom: 5px; }
    .schedule-table th { background: #555; color: white; padding: 4px 2px; text-align: center; border: 1px solid #444; font-size: 12px; }
    .schedule-table td { padding: 4px 1px; text-align: center; border: 1px solid #ddd; background: #f9f9f9; }
    .schedule-table td.direction-cell { background: #e8e8e8; font-weight: bold; font-size: 12px; color: #333; width: 45px; }

    .day-header { font-size: 10px; color: #fff; display: block; opacity: 0.9; }

    .trip-controls { display: flex; flex-direction: column; gap: 3px; align-items: center; }
    select { padding: 3px 2px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; cursor: pointer; background: white; }
    select.color-select { width: 100%; font-weight: bold; }
    select.color-select.blue { background: #5BC0DE; color: white; }
    select.color-select.green { background: #8BC34A; color: white; }
    select.color-select.orange { background: #E91E90; color: white; }
    select.color-select.red { background: #9C27B0; color: white; }
    select.time-select { width: 100%; }

    .notes-row { background: #fff8e1 !important; }
    .note-input { width: 100%; padding: 3px; border: 1px solid #ddd; border-radius: 3px; font-size: 10px; resize: none; font-family: Arial, sans-serif; }

    .requests-section { margin-bottom: 5px; padding: 5px; background: #f0f8ff; border-radius: 4px; }
    .requests-title { font-size: 10px; font-weight: bold; color: #333; margin-bottom: 4px; }
    .request-item { display: flex; gap: 4px; margin-bottom: 3px; align-items: center; }
    .request-item select { width: 60px; padding: 3px; font-size: 8px; font-weight: bold; }
    .request-item select.blue { background: #5BC0DE; color: white; }
    .request-item select.green { background: #8BC34A; color: white; }
    .request-item select.orange { background: #E91E90; color: white; }
    .request-item select.red { background: #9C27B0; color: white; }
    .request-item textarea { flex: 1; padding: 3px; border: 1px solid #ddd; border-radius: 3px; font-size: 8px; resize: none; font-family: Arial, sans-serif; }
    .add-request-btn { padding: 4px 10px; background: #4A90E2; color: white; border: none; border-radius: 3px; font-size: 8px; cursor: pointer; font-weight: bold; }
    .remove-request-btn { padding: 2px 6px; background: #ef4444; color: white; border: none; border-radius: 3px; font-size: 7px; cursor: pointer; }

    .upload-area { margin-bottom: 3px; padding: 5px; background: #f5f5f5; border-radius: 4px; text-align: center; }
    .upload-label { display: inline-block; padding: 5px 12px; background: #666; color: white; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 9px; }
    input[type="file"] { display: none; }
    .file-name { font-size: 8px; color: #666; margin-top: 3px; }
    .image-preview { margin-top: 3px; width: 100%; max-height: 120px; border-radius: 4px; display: none; object-fit: contain; border: 1px solid #ddd; cursor: pointer; }
    .image-preview.show { display: block; }
    .image-preview.zoomed { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; max-height: 100vh; background: rgba(0,0,0,0.9); z-index: 1000; border-radius: 0; object-fit: contain; padding: 20px; }

    .approval-section { padding: 8px; background: #f0f8ff; border-radius: 4px; margin-top: 5px; }
    .approval-title { font-size: 10px; font-weight: bold; color: #333; margin-bottom: 6px; text-align: center; }
    .approval-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px; }
    .approve-btn { padding: 8px; border: 2px solid; border-radius: 6px; font-size: 10px; font-weight: bold; cursor: pointer; color: white; opacity: 0.5; transition: opacity 0.3s; }
    .approve-btn.blue { background: #5BC0DE; border-color: #46A5C2; }
    .approve-btn.green { background: #8BC34A; border-color: #6FA032; }
    .approve-btn.orange { background: #E91E90; border-color: #C41878; }
    .approve-btn.red { background: #9C27B0; border-color: #7B1FA2; }
    .approve-btn.approved { opacity: 1; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .approve-btn .check-mark { display: none; font-size: 14px; }
    .approve-btn.approved .check-mark { display: inline; }

    .lock-status { text-align: center; font-size: 9px; padding: 5px; border-radius: 4px; font-weight: bold; }
    .lock-status.locked { background: #ffc107; color: #333; }

    .admin-panel { margin-top: 5px; padding: 8px; background: #fff0f0; border: 2px solid #e74c3c; border-radius: 6px; }
    .admin-panel-title { font-size: 11px; font-weight: bold; color: #e74c3c; text-align: center; margin-bottom: 6px; }
    .admin-badge { display: inline-block; padding: 1px 6px; background: #e74c3c; color: white; border-radius: 3px; font-size: 8px; font-weight: bold; }
    .admin-actions { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; }
    .admin-btn { padding: 6px 10px; border: none; border-radius: 4px; font-size: 9px; font-weight: bold; cursor: pointer; color: white; }
    .admin-btn.unlock { background: #e67e22; }
    .admin-btn.reset-approvals { background: #9b59b6; }
    .admin-btn.delete-image { background: #e74c3c; }
    .admin-btn.clear-requests { background: #34495e; }
    .admin-btn:active { opacity: 0.7; }

    .zoom-controls { display: flex; justify-content: center; gap: 6px; margin-bottom: 3px; }
    .zoom-btn { width: 28px; height: 28px; border: 1px solid #ccc; border-radius: 4px; background: #f5f5f5; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .zoom-btn:active { background: #ddd; }
    .zoom-level { font-size: 9px; color: #666; align-self: center; min-width: 30px; text-align: center; }

    .smart-fill-section { margin-bottom: 5px; padding: 8px; background: #f0fff4; border: 1px solid #10b981; border-radius: 6px; }
    .smart-fill-title { font-size: 10px; font-weight: bold; color: #065f46; margin-bottom: 5px; }
    .smart-fill-textarea { width: 100%; padding: 6px; border: 1px solid #10b981; border-radius: 4px; font-size: 9px; resize: none; font-family: Arial, sans-serif; direction: rtl; }
    .smart-fill-row { display: flex; gap: 5px; margin-top: 5px; align-items: center; }
    .smart-fill-select { padding: 4px; border: 1px solid #10b981; border-radius: 4px; font-size: 8px; background: white; flex-shrink: 0; }
    .smart-fill-btn { padding: 5px 12px; background: #10b981; color: white; border: none; border-radius: 4px; font-size: 9px; font-weight: bold; cursor: pointer; white-space: nowrap; }
    .smart-fill-btn:hover { background: #059669; }
    .smart-fill-preview { margin-top: 5px; font-size: 8px; color: #065f46; background: #d1fae5; padding: 4px; border-radius: 3px; display: none; }

    .status { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 25px; color: white; font-weight: bold; display: none; z-index: 1000; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .status.saving { background: #f59e0b; display: block; }
    .status.saved { background: #10b981; display: block; }
    .status.error { background: #ef4444; display: block; }
  </style>
</head>
<body>
  <div class="login-screen" id="loginScreen">
    <h1>×§××¨×¤×•×œ ×›×“×•×¨×¡×œ</h1>
    <p class="subtitle">×”×–×Ÿ ×§×•×“ ×’×™×©×”</p>
    <div class="form-group">
      <label>×§×•×“ ×’×™×©×”:</label>
      <input type="password" id="accessCodeInput" placeholder="×”×–×Ÿ ×§×•×“ ×’×™×©×”">
    </div>
    <button class="login-btn" id="loginBtn">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
    <div class="error-msg" id="errorMsg">×§×•×“ ×’×™×©×” ×©×’×•×™</div>
  </div>

  <div class="container" id="appContainer">
    <h1>×§××¨×¤×•×œ ×›×“×•×¨×¡×œ <span id="userName" style="font-size:9px; color:#666;"></span>
      <button onclick="logout()" style="float:left; padding:3px 8px; font-size:8px; border:none; background:#999; color:white; border-radius:3px; cursor:pointer;">×”×—×œ×£</button>
    </h1>

    <div class="top-actions">
      <button class="save-btn" id="saveBtn" onclick="saveNow()">×©××•×¨ ×œ×’×•×’×œ ×©×™×˜</button>
      <div class="dirty-indicator" id="dirtyIndicator">×œ× × ×©××¨</div>
    </div>

    <div class="zoom-controls">
      <button class="zoom-btn" onclick="changeZoom(-10)">âˆ’</button>
      <span class="zoom-level" id="zoomLevel">100%</span>
      <button class="zoom-btn" onclick="changeZoom(10)">+</button>
    </div>

    <div class="legend">
      <div class="legend-item"><div class="color-dot blue"></div><span>×ª×›×œ×ª=××•×¨×™</span></div>
      <div class="legend-item"><div class="color-dot green"></div><span>×™×¨×•×§=× ×•×¢×</span></div>
      <div class="legend-item"><div class="color-dot orange"></div><span>×•×¨×•×“=×˜××™×¨</span></div>
      <div class="legend-item"><div class="color-dot red"></div><span>×¡×’×•×œ=×¢×“×™</span></div>
    </div>

    <div class="week-nav">
      <button onclick="changeWeek(-1)">â—„ ×§×•×“×</button>
      <span class="week-title" id="weekTitle">×˜×•×¢×Ÿ...</span>
      <button onclick="changeWeek(1)">×”×‘× â–º</button>
    </div>

    <table class="schedule-table">
      <thead><tr id="dateHeaders"></tr></thead>
      <tbody id="scheduleBody"></tbody>
    </table>

    <div class="requests-section">
      <div class="requests-title">×‘×§×©×•×ª ×•××™×œ×•×¦×™×</div>
      <div id="requestsList"></div>
      <button class="add-request-btn" onclick="addRequest()">+ ×”×•×¡×£ ×‘×§×©×”</button>
    </div>

    <div class="smart-fill-section">
      <div class="smart-fill-title">âš¡ ××™×œ×•×™ ××•×˜×•××˜×™ ×œ×¤×™ ×˜×§×¡×˜ ×—×•×¤×©×™</div>
      <textarea class="smart-fill-textarea" id="smartFillText" rows="3" placeholder="×œ×“×•×’××”: ××•×¨×™ × ×•×¡×¢ ×”×œ×•×š ×‘×™×•× ×¨××©×•×Ÿ ×‘-16:00 ×•×—×–×•×¨ ×‘×™×•× ×©× ×™ ×‘-19:30, × ×•×¢× ×œ×•×§×— ×”×œ×•×š ×•×—×–×•×¨ ×‘×™×•× ×¨×‘×™×¢×™ ×‘-17:00"></textarea>
      <div class="smart-fill-row">
        <select class="smart-fill-select" id="smartFillMode">
          <option value="add">×”×•×¡×£ ×¢×œ ×§×™×™×</option>
          <option value="replace">×”×—×œ×£ ×”×›×œ</option>
        </select>
        <button class="smart-fill-btn" onclick="smartFill()">ğŸ“‹ ××§× ×‘×¡×™×“×•×¨</button>
      </div>
      <div class="smart-fill-preview" id="smartFillPreview"></div>
    </div>

    <div class="upload-area">
      <label for="imageUpload" class="upload-label">×”×¢×œ×” ×ª××•× ×ª ×¡×™×“×•×¨</label>
      <input type="file" id="imageUpload" accept="image/*">
      <div class="file-name" id="fileName"></div>
      <img id="imagePreview" class="image-preview" alt="×ª××•× ×ª ×¡×™×“×•×¨">
    </div>

    <div class="approval-section">
      <div class="approval-title">××™×©×•×¨ ×¡×™×“×•×¨</div>
      <div class="approval-buttons">
        <button class="approve-btn blue" id="approve-blue" onclick="toggleApproval('blue')"><span class="check-mark">âœ“</span> ××•×¨×™</button>
        <button class="approve-btn green" id="approve-green" onclick="toggleApproval('green')"><span class="check-mark">âœ“</span> × ×•×¢×</button>
        <button class="approve-btn orange" id="approve-orange" onclick="toggleApproval('orange')"><span class="check-mark">âœ“</span> ×˜××™×¨</button>
        <button class="approve-btn red" id="approve-red" onclick="toggleApproval('red')"><span class="check-mark">âœ“</span> ×¢×“×™</button>
      </div>
      <div class="lock-status" id="lockStatus"></div>
    </div>

    <div class="admin-panel" id="adminPanel" style="display:none;">
      <div class="admin-panel-title">×¤×× ×œ ×× ×”×œ</div>
      <div class="admin-actions">
        <button class="admin-btn unlock" onclick="adminUnlock()">×‘×˜×œ × ×¢×™×œ×”</button>
        <button class="admin-btn reset-approvals" onclick="adminResetApprovals()">××¤×¡ ××™×©×•×¨×™×</button>
        <button class="admin-btn delete-image" onclick="adminDeleteImage()">××—×§ ×ª××•× ×”</button>
        <button class="admin-btn clear-requests" onclick="adminClearRequests()">××—×§ ×‘×§×©×•×ª</button>
      </div>
    </div>
  </div>

  <div id="status" class="status"></div>

  <script>
    const DAYS = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday'];
    const DAY_NAMES = ['××³', '×‘×³', '×’×³', '×“×³', '×”×³'];
    const DIRECTIONS = [{ key: 'out', label: '×”×œ×•×š' }, { key: 'return', label: '×—×–×•×¨' }];

    const COLORS = [
      { value: '', label: '---', class: '' },
      { value: 'blue', label: '××•×¨×™', class: 'blue' },
      { value: 'green', label: '× ×•×¢×', class: 'green' },
      { value: 'orange', label: '×˜××™×¨', class: 'orange' },
      { value: 'red', label: '×¢×“×™', class: 'red' }
    ];

    const TIMES = [];
    for (let hour = 15; hour <= 21; hour++) {
      for (let minute = 0; minute < 60; minute += 15) {
        if (hour === 21 && minute > 30) break;
        TIMES.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
      }
    }

    let scheduleData = {};
    // ×™×•× ×©×™×©×™ (5) ×•×©×‘×ª (6) â€“ ×§×¤×•×¥ ×œ×©×‘×•×¢ ×”×‘×
    let currentWeekOffset = (new Date().getDay() >= 5) ? 1 : 0;
    let requests = [];
    let approvals = { blue: false, green: false, orange: false, red: false };
    let isLocked = false;

    // Image state (saved in Google Drive via Apps Script)
    let scheduleImageUrl = '';
    let scheduleImageName = '';
    let scheduleImageData = '';

    let currentUser = null;

    let isDirty = false;
    let isSaving = false;

    const API_URL = "https://basketball-carpool-backend-246561042500.me-west1.run.app/api";

    function init() {
      const savedUser = localStorage.getItem('carpool_user');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showApp();
      }

      const loginBtn = document.getElementById('loginBtn');
      const accessCodeInput = document.getElementById('accessCodeInput');

      accessCodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
      });
      loginBtn.addEventListener('click', handleLogin);

      window.addEventListener('beforeunload', (e) => {
        if (isDirty) {
          e.preventDefault();
          e.returnValue = '';
        }
      });
    }

    async function handleLogin() {
      const accessCode = document.getElementById('accessCodeInput').value.trim();
      const errorMsg = document.getElementById('errorMsg');

      if (!accessCode) {
        errorMsg.textContent = '× × ×œ×”×–×™×Ÿ ×§×•×“ ×’×™×©×”';
        errorMsg.classList.add('show');
        return;
      }

      try {
        const response = await fetch(API_URL + '/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-API-Key': accessCode }
        });
        const data = await response.json();

        if (data.success) {
          const role = data.role || 'user';
          currentUser = { accessCode: accessCode, role: role };
          localStorage.setItem('carpool_user', JSON.stringify(currentUser));
          await showApp();
        } else {
          errorMsg.textContent = '×§×•×“ ×’×™×©×” ×©×’×•×™';
          errorMsg.classList.add('show');
        }
      } catch (error) {
        console.error('Login error:', error);
        errorMsg.textContent = '×©×’×™××ª ×ª×§×©×•×¨×ª';
        errorMsg.classList.add('show');
      }
    }

    function isAdmin() {
      return currentUser && currentUser.role === 'admin';
    }

    async function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appContainer').classList.add('active');

      // Show admin badge and panel
      if (isAdmin()) {
        document.getElementById('userName').innerHTML = '<span class="admin-badge">×× ×”×œ</span>';
        document.getElementById('adminPanel').style.display = 'block';
      } else {
        document.getElementById('userName').textContent = '';
        document.getElementById('adminPanel').style.display = 'none';
      }

      updateWeekDisplay();

      await loadWeekData(); // server first
      renderAll();
      applyZoom();

      const imageUpload = document.getElementById('imageUpload');
      const imagePreview = document.getElementById('imagePreview');

      imageUpload.addEventListener('change', handleImageUpload);
      imagePreview.addEventListener('click', function() { this.classList.toggle('zoomed'); });

      setDirty(false);
    }

    function logout() {
      localStorage.removeItem('carpool_user');
      currentUser = null;

      scheduleData = {};
      requests = [];
      approvals = { blue: false, green: false, orange: false, red: false };
      isLocked = false;

      // Clear image state (next login will reload from server/cache)
      scheduleImageUrl = '';
      scheduleImageName = '';
      scheduleImageData = '';

      // Clear UI elements related to image upload
      try { document.getElementById('imageUpload').value = ''; } catch (_) {}
      try { document.getElementById('fileName').textContent = ''; } catch (_) {}
      try {
        const preview = document.getElementById('imagePreview');
        preview.src = '';
        preview.classList.remove('show', 'zoomed');
      } catch (_) {}

      setDirty(false);

      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('appContainer').classList.remove('active');
      document.getElementById('accessCodeInput').value = '';
      document.getElementById('errorMsg').classList.remove('show');
    }

    function getWeekDates(offset) {
      const today = new Date();
      const sunday = new Date(today);
      sunday.setDate(today.getDate() - today.getDay() + (offset * 7));

      const dates = [];
      for (let i = 0; i < 5; i++) {
        const d = new Date(sunday);
        d.setDate(sunday.getDate() + i);
        dates.push(d);
      }
      return dates;
    }

    function getWeekKey(offset) {
      const dates = getWeekDates(offset);
      return `${dates[0].getFullYear()}-${dates[0].getMonth() + 1}-${dates[0].getDate()}`;
    }

    function formatDate(d) { return `${d.getDate()}/${d.getMonth() + 1}`; }

    function updateWeekDisplay() {
      const dates = getWeekDates(currentWeekOffset);
      document.getElementById('weekTitle').textContent = `${formatDate(dates[0])} - ${formatDate(dates[4])}`;

      const dateHeaders = document.getElementById('dateHeaders');
      dateHeaders.innerHTML = '<th></th>';
      dates.forEach((date, i) => {
        const th = document.createElement('th');
        th.innerHTML = `${DAY_NAMES[i]}<br><span class="day-header">${formatDate(date)}</span>`;
        dateHeaders.appendChild(th);
      });
    }

    async function changeWeek(direction) {
      if (isDirty) {
        const ok = confirm('×™×© ×©×™× ×•×™×™× ×©×œ× × ×©××¨×•. ×œ×¢×‘×•×¨ ×©×‘×•×¢ ×‘×œ×™ ×œ×©××•×¨?');
        if (!ok) return;
      }

      currentWeekOffset += direction;
      updateWeekDisplay();
      await loadWeekData();
      renderAll();
      setDirty(false);
    }

    function renderAll() {
      renderSchedule();
      renderRequests();
      renderApprovals();
      checkLockStatus();
      renderImage();
    }

    function getProxiedImageUrl(driveUrl) {
      if (!driveUrl) return '';
      // Route Google Drive image through our proxy to avoid CORS issues
      return API_URL + '/image-proxy?url=' + encodeURIComponent(driveUrl);
    }

    function renderImage() {
      const preview = document.getElementById('imagePreview');
      const fileNameEl = document.getElementById('fileName');

      // Priority 1: local base64 data (new upload, not yet saved)
      if (scheduleImageData) {
        preview.onerror = null;
        preview.src = scheduleImageData;
        preview.classList.add('show');
        fileNameEl.textContent = scheduleImageName ? `âœ“ ${scheduleImageName}` : 'âœ“ ×ª××•× ×ª ×¡×™×“×•×¨';
        return;
      }

      // Priority 2: server URL via proxy
      if (scheduleImageUrl) {
        const proxiedUrl = getProxiedImageUrl(scheduleImageUrl);
        preview.onerror = function() {
          preview.classList.remove('show');
          fileNameEl.textContent = 'âš  ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×ª××•× ×”';
        };
        // Add auth header via fetch, then set as blob URL
        fetch(proxiedUrl, {
          headers: { 'X-API-Key': currentUser ? currentUser.accessCode : '' }
        })
        .then(resp => {
          if (!resp.ok) throw new Error('Failed');
          return resp.blob();
        })
        .then(blob => {
          const blobUrl = URL.createObjectURL(blob);
          preview.onerror = null;
          preview.src = blobUrl;
          preview.classList.add('show');
          fileNameEl.textContent = scheduleImageName ? `âœ“ ${scheduleImageName}` : 'âœ“ ×ª××•× ×ª ×¡×™×“×•×¨';
        })
        .catch(() => {
          preview.classList.remove('show');
          fileNameEl.textContent = 'âš  ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×ª××•× ×”';
        });
      } else {
        preview.onerror = null;
        preview.src = '';
        preview.classList.remove('show');
        fileNameEl.textContent = '';
      }
    }

    function renderSchedule() {
      const tbody = document.getElementById('scheduleBody');
      tbody.innerHTML = '';

      DIRECTIONS.forEach(direction => {
        const tr = document.createElement('tr');

        const tdDir = document.createElement('td');
        tdDir.className = 'direction-cell';
        tdDir.textContent = direction.label;
        tr.appendChild(tdDir);

        DAYS.forEach(day => {
          const td = document.createElement('td');
          td.innerHTML = `
            <div class="trip-controls">
              ${createColorSelect(direction.key, day)}
              ${createTimeSelect(direction.key, day)}
            </div>
          `;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      const notesRow = document.createElement('tr');
      notesRow.className = 'notes-row';
      const tdLabel = document.createElement('td');
      tdLabel.className = 'direction-cell';
      tdLabel.textContent = '×”×¢×¨×•×ª';
      notesRow.appendChild(tdLabel);

      DAYS.forEach((day) => {
        const td = document.createElement('td');
        const savedNote = scheduleData.notes?.[day] || '';
        td.innerHTML = `<textarea class="note-input" data-day="${day}" rows="2" placeholder="×”×¢×¨×”...">${savedNote}</textarea>`;
        notesRow.appendChild(td);
      });

      tbody.appendChild(notesRow);

      document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', handleChange);
      });

      document.querySelectorAll('.note-input').forEach(textarea => {
        textarea.addEventListener('input', handleNoteChange);
      });

      if (isLocked) disableInputs(); else enableInputs();
      // ×©××•×¨ ×–×•× ××—×¨×™ ×¨×™× ×“×•×¨ ××—×“×©
      setTimeout(applyZoom, 0);
    }

    function createColorSelect(direction, day) {
      const savedColor = (scheduleData[direction] && scheduleData[direction][day] && scheduleData[direction][day].color) || '';
      let html = `<select class="color-select ${savedColor}" data-direction="${direction}" data-day="${day}" data-type="color">`;
      COLORS.forEach(color => {
        html += `<option value="${color.value}" ${color.value === savedColor ? 'selected' : ''}>${color.label}</option>`;
      });
      html += '</select>';
      return html;
    }

    function createTimeSelect(direction, day) {
      const savedTime = (scheduleData[direction] && scheduleData[direction][day] && scheduleData[direction][day].time) || '';
      let html = `<select class="time-select" data-direction="${direction}" data-day="${day}" data-type="time">`;
      html += '<option value="">--:--</option>';
      TIMES.forEach(time => {
        html += `<option value="${time}" ${time === savedTime ? 'selected' : ''}>${time}</option>`;
      });
      html += '</select>';
      return html;
    }

    function handleChange(e) {
      if (isLocked && !isAdmin()) return;

      const select = e.target;
      const direction = select.dataset.direction;
      const day = select.dataset.day;
      const type = select.dataset.type;
      const value = select.value;

      if (!scheduleData[direction]) scheduleData[direction] = {};
      if (!scheduleData[direction][day]) scheduleData[direction][day] = {};
      scheduleData[direction][day][type] = value;

      if (type === 'color') {
        select.className = `color-select ${value}`;
      }

      saveToLocalStorage();
      setDirty(true);
    }

    function handleNoteChange(e) {
      if (isLocked && !isAdmin()) return;

      const textarea = e.target;
      const day = textarea.dataset.day;

      if (!scheduleData.notes) scheduleData.notes = {};
      scheduleData.notes[day] = textarea.value;

      saveToLocalStorage();
      setDirty(true);
    }

    function addRequest() {
      if (isLocked && !isAdmin()) { alert('×”×¡×™×“×•×¨ × ×¢×•×œ'); return; }
      requests.push({ child: '', text: '' });
      renderRequests();
      saveToLocalStorage();
      setDirty(true);
    }

    function removeRequest(index) {
      if (isLocked && !isAdmin()) { alert('×”×¡×™×“×•×¨ × ×¢×•×œ'); return; }
      requests.splice(index, 1);
      renderRequests();
      saveToLocalStorage();
      setDirty(true);
    }

    function renderRequests() {
      const container = document.getElementById('requestsList');
      container.innerHTML = '';

      requests.forEach((req, index) => {
        const div = document.createElement('div');
        div.className = 'request-item';
        div.innerHTML = `
          <select class="${req.child}" onchange="updateRequestChild(${index}, this.value)">
            ${COLORS.map(c => `<option value="${c.value}" ${c.value === req.child ? 'selected' : ''}>${c.label}</option>`).join('')}
          </select>
          <textarea rows="1" placeholder="×œ×“×•×’××”: ××¢×“×™×£ ×‘×™×•× ×’×³" oninput="updateRequestText(${index}, this.value)">${req.text || ''}</textarea>
          <button class="remove-request-btn" onclick="removeRequest(${index})">Ã—</button>
        `;
        container.appendChild(div);
      });
    }

    function updateRequestChild(index, value) {
      if (isLocked && !isAdmin()) return;
      requests[index].child = value;
      renderRequests();
      saveToLocalStorage();
      setDirty(true);
    }

    function updateRequestText(index, value) {
      if (isLocked && !isAdmin()) return;
      requests[index].text = value;
      saveToLocalStorage();
      setDirty(true);
    }

    function dataUrlApproxBytes(dataUrl) {
      // Rough estimate of bytes from base64 length
      if (!dataUrl) return 0;
      const comma = dataUrl.indexOf(',');
      const b64 = comma >= 0 ? dataUrl.slice(comma + 1) : dataUrl;
      return Math.floor((b64.length * 3) / 4);
    }

    function compressImageToDataUrl(file, opts) {
      const options = Object.assign({
        maxWidth: 1200,
        maxHeight: 1200,
        mime: 'image/jpeg',
        quality: 0.82,
        maxBytes: 900 * 1024
      }, opts || {});

      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('FileReader error'));
        reader.onload = () => {
          const img = new Image();
          img.onerror = () => reject(new Error('Image load error'));
          img.onload = () => {
            let { width, height } = img;

            const scale = Math.min(
              1,
              options.maxWidth / width,
              options.maxHeight / height
            );

            width = Math.max(1, Math.round(width * scale));
            height = Math.max(1, Math.round(height * scale));

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            let q = options.quality;
            let out = canvas.toDataURL(options.mime, q);

            // If still too big, reduce quality a bit
            let guard = 0;
            while (dataUrlApproxBytes(out) > options.maxBytes && q > 0.5 && guard < 6) {
              q = q - 0.07;
              out = canvas.toDataURL(options.mime, q);
              guard++;
            }

            resolve(out);
          };
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function handleImageUpload(event) {
      if (isLocked && !isAdmin()) { 
        alert('×”×¡×™×“×•×¨ × ×¢×•×œ'); 
        event.target.value = '';
        return; 
      }

      const file = event.target.files[0];
      if (!file) return;

      // On mobile, images can be very large. We compress + resize before saving.
      try {
        document.getElementById('fileName').textContent = `××¢×‘×“ ×ª××•× ×”...`;

        const dataUrl = await compressImageToDataUrl(file, {
          maxWidth: 1400,
          maxHeight: 1400,
          maxBytes: 900 * 1024
        });

        // keep for save (server will store in Drive)
        scheduleImageData = dataUrl;
        scheduleImageName = file.name;

        // optimistic preview
        const preview = document.getElementById('imagePreview');
        preview.src = dataUrl;
        preview.classList.add('show');

        const approxKb = Math.round(dataUrlApproxBytes(dataUrl) / 1024);
        document.getElementById('fileName').textContent = `âœ“ ${file.name} (×œ××—×¨ ×“×—×™×¡×”: ~${approxKb}KB)`;

        setDirty(true);
        saveToLocalStorage();
      } catch (err) {
        console.error('Image compress error:', err);
        alert('×œ× ×”×¦×œ×—×ª×™ ×œ×¢×‘×“ ××ª ×”×ª××•× ×”. × ×¡×” ×ª××•× ×” ××—×¨×ª.');
        event.target.value = '';
        document.getElementById('fileName').textContent = '';
      }
    }

    function setDirty(flag) {
      isDirty = !!flag;
      const ind = document.getElementById('dirtyIndicator');
      const btn = document.getElementById('saveBtn');
      if (isDirty) {
        ind.textContent = '×œ× × ×©××¨';
        btn.disabled = false;
      } else {
        ind.textContent = '× ×©××¨';
        btn.disabled = false;
      }
    }

    // FIX: include imageData + imageName in payload so Apps Script can save to Drive
    function buildWeekDataPayload(weekKey) {
      return {
        weekKey: weekKey,
        weekData: {
          schedule: scheduleData,
          requests: requests,
          approvals: approvals,
          locked: isLocked,

          imageData: (scheduleImageData || ''),
          imageName: (scheduleImageName || ''),
          imageUrl: (scheduleImageUrl || ''),
          imageNameSaved: (scheduleImageName || '')
        }
      };
    }

    function saveToLocalStorage() {
      const weekKey = getWeekKey(currentWeekOffset);
      const allData = JSON.parse(localStorage.getItem('carpoolAllWeeks') || '{}');
      const wd = buildWeekDataPayload(weekKey).weekData;

      // Avoid bloating localStorage with base64
      wd.imageData = '';

      // Keep the last known Drive image URL in the local cache (so "×”×—×œ×£" / offline won't hide it)
      wd.imageUrl = scheduleImageUrl || '';
      wd.imageName = scheduleImageName || '';

      allData[weekKey] = wd;
      localStorage.setItem('carpoolAllWeeks', JSON.stringify(allData));
    }

    async function saveNow() {
      const weekKey = getWeekKey(currentWeekOffset);
      await saveToServer(weekKey);
    }

    async function saveToServer(weekKey) {
      if (!currentUser || !currentUser.accessCode) return;
      if (isSaving) return;

      isSaving = true;
      showStatus('saving', '×©×•××¨...');

      // Keep a copy of the image data before clearing
      const savedImageData = scheduleImageData || '';
      const savedImageName = scheduleImageName || '';

      try {
        const payload = buildWeekDataPayload(weekKey);
        const response = await fetch(API_URL + '?action=save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-API-Key': currentUser.accessCode },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!result.success) {
          showStatus('error', '×©×’×™××” ×‘×©××™×¨×”');
        } else {
          scheduleImageData = '';
          await loadFromServer(weekKey);

          // Test if the server image URL actually loads
          if (scheduleImageUrl) {
            const testImg = new Image();
            const urlToTest = scheduleImageUrl;
            testImg.onload = function() {
              // URL works fine, render normally
              renderImage();
            };
            testImg.onerror = function() {
              // URL failed - keep the local base64 copy as fallback
              if (savedImageData) {
                scheduleImageData = savedImageData;
                scheduleImageName = savedImageName;
              }
              renderImage();
            };
            testImg.src = urlToTest;
          } else if (savedImageData) {
            // No URL returned from server, keep local copy
            scheduleImageData = savedImageData;
            scheduleImageName = savedImageName;
            renderImage();
          } else {
            renderImage();
          }

          showStatus('saved', '× ×©××¨ âœ“');
          setDirty(false);
        }
      } catch (error) {
        console.error('Save error:', error);
        showStatus('error', '×©×’×™××ª ×ª×§×©×•×¨×ª');
      } finally {
        isSaving = false;
      }
    }

    async function loadWeekData() {
      const weekKey = getWeekKey(currentWeekOffset);

      if (currentUser && currentUser.accessCode) {
        const ok = await loadFromServer(weekKey);
        if (ok) return;
      }

      const allData = JSON.parse(localStorage.getItem('carpoolAllWeeks') || '{}');
      const weekData = allData[weekKey] || {};
      scheduleData = weekData.schedule || {};
      requests = weekData.requests || [];
      approvals = weekData.approvals || { blue: false, green: false, orange: false, red: false };
      isLocked = weekData.locked || false;
      scheduleImageUrl = weekData.imageUrl || '';
      scheduleImageName = weekData.imageName || '';
      scheduleImageData = '';
    }

    async function loadFromServer(weekKey) {
      try {
        const response = await fetch(API_URL + `?action=load&weekKey=${encodeURIComponent(weekKey)}`, {
          method: 'GET',
          headers: { 'X-API-Key': currentUser.accessCode }
        });

        const result = await response.json();
        if (!result.success) return false;

        const serverData = result.weekData || {};
        scheduleData = (serverData.schedule || {});
        if (!scheduleData.out) scheduleData.out = {};
        if (!scheduleData.return) scheduleData.return = {};
        if (!scheduleData.notes) scheduleData.notes = {};

        requests = Array.isArray(serverData.requests) ? serverData.requests : [];
        approvals = serverData.approvals || { blue: false, green: false, orange: false, red: false };
        isLocked = !!serverData.locked;

        scheduleImageUrl = serverData.imageUrl || '';
        scheduleImageName = serverData.imageName || '';
        scheduleImageData = '';

        const allData = JSON.parse(localStorage.getItem('carpoolAllWeeks') || '{}');
        allData[weekKey] = serverData;
        localStorage.setItem('carpoolAllWeeks', JSON.stringify(allData));

        return true;
      } catch (error) {
        console.error('Load error:', error);
        return false;
      }
    }

    function toggleApproval(color) {
      if (isLocked && !isAdmin()) {
        alert('×”×¡×™×“×•×¨ × ×¢×•×œ');
        return;
      }

      approvals[color] = !approvals[color];
      renderApprovals();
      checkLockStatus();
      saveToLocalStorage();
      setDirty(true);
    }

    function renderApprovals() {
      ['blue', 'green', 'orange', 'red'].forEach(color => {
        const btn = document.getElementById(`approve-${color}`);
        if (approvals[color]) btn.classList.add('approved');
        else btn.classList.remove('approved');
      });
    }

    function checkLockStatus() {
      const allApproved = Object.values(approvals).every(val => val === true);
      isLocked = allApproved;

      const lockStatus = document.getElementById('lockStatus');
      if (isLocked) {
        lockStatus.textContent = '×”×¡×™×“×•×¨ × ×¢×•×œ - ×›×•×œ× ××™×©×¨×•';
        lockStatus.className = 'lock-status locked';
        if (!isAdmin()) {
          disableInputs();
        }
      } else {
        const approved = Object.values(approvals).filter(v => v).length;
        lockStatus.textContent = `××•×©×¨ ×¢×œ ×™×“×™ ${approved}/4 ×”×•×¨×™×`;
        lockStatus.className = 'lock-status';
        enableInputs();
      }
    }

    function disableInputs() {
      document.querySelectorAll('.schedule-table select, .schedule-table textarea').forEach(el => {
        el.disabled = true;
        el.style.pointerEvents = 'none';
      });
    }

    function enableInputs() {
      document.querySelectorAll('.schedule-table select, .schedule-table textarea').forEach(el => {
        el.disabled = false;
        el.style.pointerEvents = 'auto';
      });
    }

    function showStatus(type, text) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = text;
      statusEl.className = 'status ' + type;

      if (type !== 'saving') {
        setTimeout(() => { statusEl.className = 'status'; }, 2500);
      }
    }

    // ========== Zoom Controls ==========
    let currentZoom = parseInt(localStorage.getItem('carpoolZoom') || '100', 10);

    function applyZoom() {
      const scale = currentZoom / 100;
      const table = document.querySelector('.schedule-table');
      if (table) {
        table.style.fontSize = (8 * scale) + 'px';
        table.querySelectorAll('th').forEach(el => el.style.fontSize = (9 * scale) + 'px');
        table.querySelectorAll('.direction-cell').forEach(el => el.style.fontSize = (9 * scale) + 'px');
        table.querySelectorAll('select').forEach(el => {
          el.style.fontSize = (8 * scale) + 'px';
          el.style.width = 'auto';
        });
        table.querySelectorAll('.color-select').forEach(el => el.style.width = (55 * scale) + 'px');
        table.querySelectorAll('.time-select').forEach(el => el.style.width = (48 * scale) + 'px');
        table.querySelectorAll('.note-input').forEach(el => el.style.fontSize = (7 * scale) + 'px');
        table.querySelectorAll('.day-header').forEach(el => el.style.fontSize = (7 * scale) + 'px');
      }
      document.getElementById('zoomLevel').textContent = currentZoom + '%';
    }

    function changeZoom(delta) {
      currentZoom = Math.max(60, Math.min(160, currentZoom + delta));
      localStorage.setItem('carpoolZoom', String(currentZoom));
      applyZoom();
    }

    // ========== Admin Functions ==========
    function adminUnlock() {
      if (!isAdmin()) return;
      if (!confirm('×œ×‘×˜×œ ××ª × ×¢×™×œ×ª ×”×¡×™×“×•×¨?')) return;

      approvals = { blue: false, green: false, orange: false, red: false };
      isLocked = false;
      renderApprovals();
      checkLockStatus();
      enableInputs();
      saveToLocalStorage();
      setDirty(true);
      showStatus('saved', '× ×¢×™×œ×” ×‘×•×˜×œ×”');
    }

    function adminResetApprovals() {
      if (!isAdmin()) return;
      if (!confirm('×œ××¤×¡ ××ª ×›×œ ×”××™×©×•×¨×™×?')) return;

      approvals = { blue: false, green: false, orange: false, red: false };
      isLocked = false;
      renderApprovals();
      checkLockStatus();
      enableInputs();
      saveToLocalStorage();
      setDirty(true);
      showStatus('saved', '××™×©×•×¨×™× ××•×¤×¡×•');
    }

    function adminDeleteImage() {
      if (!isAdmin()) return;
      if (!confirm('×œ××—×•×§ ××ª ×ª××•× ×ª ×”×¡×™×“×•×¨?')) return;

      scheduleImageUrl = '';
      scheduleImageName = '';
      scheduleImageData = 'REMOVE';
      renderImage();

      // Reset image display
      const preview = document.getElementById('imagePreview');
      preview.src = '';
      preview.classList.remove('show');
      document.getElementById('fileName').textContent = '';
      document.getElementById('imageUpload').value = '';

      saveToLocalStorage();
      setDirty(true);
      showStatus('saved', '×ª××•× ×” × ××—×§×”');
    }

    function adminClearRequests() {
      if (!isAdmin()) return;
      if (!confirm('×œ××—×•×§ ××ª ×›×œ ×”×‘×§×©×•×ª?')) return;

      requests = [];
      renderRequests();
      saveToLocalStorage();
      setDirty(true);
      showStatus('saved', '×‘×§×©×•×ª × ××—×§×•');
    }

    // ========== Smart Fill ==========
    function smartFill() {
      if (isLocked && !isAdmin()) { alert('×”×¡×™×“×•×¨ × ×¢×•×œ'); return; }

      const text = document.getElementById('smartFillText').value.trim();
      if (!text) { alert('×™×© ×œ×”×–×™×Ÿ ×˜×§×¡×˜'); return; }

      const mode = document.getElementById('smartFillMode').value;

      // Mappings
      const colorMap = {
        '××•×¨×™': 'blue', 'uri': 'blue', '××•×¨×™': 'blue',
        '× ×•×¢×': 'green', 'noam': 'green',
        '×˜××™×¨': 'orange', 'tamir': 'orange',
        '×¢×“×™': 'red', 'adi': 'red'
      };
      const dayMap = {
        '×¨××©×•×Ÿ': 'sunday', '××³': 'sunday', "×'": 'sunday', 'sunday': 'sunday',
        '×©× ×™': 'monday', '×‘×³': 'monday', "×‘'": 'monday', 'monday': 'monday',
        '×©×œ×™×©×™': 'tuesday', '×’×³': 'tuesday', "×’'": 'tuesday', 'tuesday': 'tuesday',
        '×¨×‘×™×¢×™': 'wednesday', '×“×³': 'wednesday', "×“'": 'wednesday', 'wednesday': 'wednesday',
        '×—××™×©×™': 'thursday', '×”×³': 'thursday', "×”'": 'thursday', 'thursday': 'thursday'
      };
      const dirMap = {
        '×”×œ×•×š': 'out', '×œ×§×—×ª': 'out', '×œ×•×§×—': 'out', '×œ×§×—×ª': 'out', '× ×¡×™×¢×”': 'out',
        '×—×–×•×¨': 'return', '×—×–×¨×”': 'return', '×œ×—×–×•×¨': 'return', '××—×–×™×¨': 'return', '××—×–×™×¨×”': 'return',
        '×©× ×™×”×': 'both', '×”×œ×•×š ×•×—×–×•×¨': 'both', '×•×—×–×•×¨': 'both'
      };

      const changes = [];

      // Split into segments by person name
      const segments = [];
      const colorNames = Object.keys(colorMap);

      // Find all name positions
      const namePositions = [];
      colorNames.forEach(name => {
        let pos = 0;
        while ((pos = text.indexOf(name, pos)) !== -1) {
          namePositions.push({ pos, name });
          pos += name.length;
        }
      });
      namePositions.sort((a, b) => a.pos - b.pos);

      // Extract unique segments per person
      for (let i = 0; i < namePositions.length; i++) {
        const start = namePositions[i].pos;
        const end = namePositions[i + 1] ? namePositions[i + 1].pos : text.length;
        segments.push({ name: namePositions[i].name, segment: text.substring(start, end) });
      }

      if (segments.length === 0) {
        // Try to parse without person name context (single person segment)
        segments.push({ name: null, segment: text });
      }

      if (mode === 'replace') {
        // Clear schedule
        scheduleData.out = {};
        scheduleData.return = {};
      }

      // Parse each segment
      segments.forEach(({ name, segment }) => {
        const color = name ? colorMap[name] : null;
        if (!color) return;

        // Find days and directions in this segment
        const lowerSeg = segment;

        // Check for "×”×œ×•×š ×•×—×–×•×¨" patterns
        const bothPattern = /×”×œ×•×š\s*×•×—×–×•×¨/g;
        let hasBoth = bothPattern.test(lowerSeg);

        Object.keys(dayMap).forEach(dayHebrew => {
          if (!lowerSeg.includes(dayHebrew)) return;
          const day = dayMap[dayHebrew];

          // Extract time near this day mention
          const dayPos = lowerSeg.indexOf(dayHebrew);
          const context = lowerSeg.substring(Math.max(0, dayPos - 30), Math.min(lowerSeg.length, dayPos + 60));
          const timeMatch = context.match(/(\d{1,2})[:\.](\d{2})/);
          const time = timeMatch ? `${timeMatch[1].padStart(2, '0')}:${timeMatch[2]}` : '';

          // Determine direction from context around this day
          const contextBefore = lowerSeg.substring(Math.max(0, dayPos - 60), dayPos + dayHebrew.length + 30);
          let dir = null;

          if (hasBoth || /×”×œ×•×š\s*×•×—×–×•×¨/.test(contextBefore)) {
            dir = 'both';
          } else {
            for (const [dirWord, dirVal] of Object.entries(dirMap)) {
              if (dirVal === 'both') continue;
              if (contextBefore.includes(dirWord)) { dir = dirVal; break; }
            }
          }

          if (!dir) dir = 'out'; // default

          if (dir === 'both' || dir === 'out') {
            if (!scheduleData.out) scheduleData.out = {};
            if (!scheduleData.out[day]) scheduleData.out[day] = {};
            scheduleData.out[day].color = color;
            if (time) scheduleData.out[day].time = time;
            changes.push(`${name} ×”×œ×•×š ${dayHebrew}${time ? ' ' + time : ''}`);
          }
          if (dir === 'both' || dir === 'return') {
            if (!scheduleData.return) scheduleData.return = {};
            if (!scheduleData.return[day]) scheduleData.return[day] = {};
            scheduleData.return[day].color = color;
            if (time) scheduleData.return[day].time = time;
            changes.push(`${name} ×—×–×•×¨ ${dayHebrew}${time ? ' ' + time : ''}`);
          }
        });
      });

      if (changes.length === 0) {
        alert('×œ× ×–×•×”×• × ×¡×™×¢×•×ª. × ×¡×” ×œ×¦×™×™×Ÿ ×©× (××•×¨×™/× ×•×¢×/×˜××™×¨/×¢×“×™), ×™×•× (×¨××©×•×Ÿ/×©× ×™...) ×•×›×™×•×•×Ÿ (×”×œ×•×š/×—×–×•×¨)');
        return;
      }

      renderSchedule();
      saveToLocalStorage();
      setDirty(true);

      const preview = document.getElementById('smartFillPreview');
      preview.textContent = 'âœ“ ××•×§×: ' + changes.join(' | ');
      preview.style.display = 'block';

      showStatus('saved', `âœ“ ${changes.length} × ×¡×™×¢×•×ª ××•×§××•`);
    }

    init();
  </script>
</body>
</html>
