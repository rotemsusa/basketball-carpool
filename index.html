<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>×§××¨×¤×•×œ ×›×“×•×¨×¡×œ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: Arial, sans-serif;
      background: #2a2a2a;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 3px;
    }
    
    .login-screen {
      background: white;
      border-radius: 15px;
      padding: 30px 25px;
      width: 90vw;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .login-screen h1 {
      font-size: 22px;
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .login-screen .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 25px;
      text-align: center;
    }
    
    .form-group {
      width: 100%;
      margin-bottom: 18px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .form-group select,
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: Arial, sans-serif;
    }
    
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #4A90E2;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .checkbox-group label {
      font-size: 13px;
      color: #333;
      cursor: pointer;
    }
    
    .password-field {
      display: none;
    }
    
    .password-field.show {
      display: block;
    }
    
    .login-btn {
      width: 100%;
      padding: 14px;
      background: #4A90E2;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .login-btn:hover {
      background: #357ABD;
    }
    
    .login-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .error-msg {
      color: #D0021B;
      font-size: 13px;
      margin-top: 10px;
      text-align: center;
      display: none;
    }
    
    .error-msg.show {
      display: block;
    }
    
    .container {
      background: white;
      border-radius: 10px;
      padding: 6px;
      width: 99vw;
      max-width: 600px;
      display: none;
    }
    
    .container.active {
      display: block;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 3px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .legend {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-bottom: 3px;
      padding: 3px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 8px;
      font-weight: bold;
    }
    
    .color-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      border: 1px solid #ddd;
    }
    
    .color-dot.blue { background: #4A90E2; }
    .color-dot.green { background: #7ED321; }
    .color-dot.orange { background: #F5A623; }
    .color-dot.red { background: #D0021B; }
    
    .week-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3px;
      padding: 3px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    
    .week-nav button {
      padding: 3px 8px;
      border: none;
      border-radius: 3px;
      background: #555;
      color: white;
      font-size: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .week-title {
      font-size: 9px;
      font-weight: bold;
      color: #333;
    }
    
    .schedule-table {
      border-collapse: collapse;
      font-size: 8px;
      width: 100%;
      margin-bottom: 5px;
    }
    
    .schedule-table th {
      background: #555;
      color: white;
      padding: 4px 2px;
      text-align: center;
      border: 1px solid #444;
      font-size: 9px;
    }
    
    .schedule-table td {
      padding: 4px 1px;
      text-align: center;
      border: 1px solid #ddd;
      background: #f9f9f9;
    }
    
    .schedule-table td.direction-cell {
      background: #e8e8e8;
      font-weight: bold;
      font-size: 9px;
      color: #333;
      width: 45px;
    }
    
    .day-header {
      font-size: 7px;
      color: #fff;
      display: block;
      opacity: 0.9;
    }
    
    .trip-controls {
      display: flex;
      flex-direction: column;
      gap: 3px;
      align-items: center;
    }
    
    select {
      padding: 3px 2px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 8px;
      cursor: pointer;
      background: white;
    }
    
    select.color-select {
      width: 55px;
      font-weight: bold;
    }
    
    select.color-select.blue { background: #4A90E2; color: white; }
    select.color-select.green { background: #7ED321; color: white; }
    select.color-select.orange { background: #F5A623; color: white; }
    select.color-select.red { background: #D0021B; color: white; }
    
    select.time-select {
      width: 48px;
    }
    
    .notes-row {
      background: #fff8e1 !important;
    }
    
    .note-input {
      width: 100%;
      padding: 3px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 7px;
      resize: none;
      font-family: Arial, sans-serif;
    }
    
    .requests-section {
      margin-bottom: 5px;
      padding: 5px;
      background: #f0f8ff;
      border-radius: 4px;
    }
    
    .requests-title {
      font-size: 10px;
      font-weight: bold;
      color: #333;
      margin-bottom: 4px;
    }
    
    .request-item {
      display: flex;
      gap: 4px;
      margin-bottom: 3px;
      align-items: center;
    }
    
    .request-item select {
      width: 60px;
      padding: 3px;
      font-size: 8px;
      font-weight: bold;
    }
    
    .request-item select.blue { background: #4A90E2; color: white; }
    .request-item select.green { background: #7ED321; color: white; }
    .request-item select.orange { background: #F5A623; color: white; }
    .request-item select.red { background: #D0021B; color: white; }
    
    .request-item textarea {
      flex: 1;
      padding: 3px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 8px;
      resize: none;
      font-family: Arial, sans-serif;
    }
    
    .add-request-btn {
      padding: 4px 10px;
      background: #4A90E2;
      color: white;
      border: none;
      border-radius: 3px;
      font-size: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .remove-request-btn {
      padding: 2px 6px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 3px;
      font-size: 7px;
      cursor: pointer;
    }
    
    .upload-area {
      margin-bottom: 3px;
      padding: 5px;
      background: #f5f5f5;
      border-radius: 4px;
      text-align: center;
    }
    
    .upload-label {
      display: inline-block;
      padding: 5px 12px;
      background: #666;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 9px;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .file-name {
      font-size: 8px;
      color: #666;
      margin-top: 3px;
    }
    
    .image-preview {
      margin-top: 3px;
      width: 100%;
      max-height: 120px;
      border-radius: 4px;
      display: none;
      object-fit: contain;
      border: 1px solid #ddd;
      cursor: pointer;
    }
    
    .image-preview.show {
      display: block;
    }
    
    .image-preview.zoomed {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      max-height: 100vh;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      border-radius: 0;
      object-fit: contain;
      padding: 20px;
    }
    
    .approval-section {
      padding: 8px;
      background: #f0f8ff;
      border-radius: 4px;
      margin-top: 5px;
    }
    
    .approval-title {
      font-size: 10px;
      font-weight: bold;
      color: #333;
      margin-bottom: 6px;
      text-align: center;
    }
    
    .approval-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
      margin-bottom: 5px;
    }
    
    .approve-btn {
      padding: 8px;
      border: 2px solid;
      border-radius: 6px;
      font-size: 10px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      opacity: 0.5;
      transition: opacity 0.3s;
    }
    
    .approve-btn.blue { background: #4A90E2; border-color: #357ABD; }
    .approve-btn.green { background: #7ED321; border-color: #5FA818; }
    .approve-btn.orange { background: #F5A623; border-color: #D68910; }
    .approve-btn.red { background: #D0021B; border-color: #A00115; }
    
    .approve-btn.approved {
      opacity: 1;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    
    .approve-btn .check-mark {
      display: none;
      font-size: 14px;
    }
    
    .approve-btn.approved .check-mark {
      display: inline;
    }
    
    .lock-status {
      text-align: center;
      font-size: 9px;
      padding: 5px;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .lock-status.locked {
      background: #ffc107;
      color: #333;
    }
    
    .locked-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .locked-overlay.show {
      display: flex;
    }
    
    .locked-message {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <h1>ğŸ€ ×§××¨×¤×•×œ ×›×“×•×¨×¡×œ</h1>
    <p class="subtitle">×”×–×Ÿ ×§×•×“ ×’×™×©×”</p>
    
    <div class="form-group">
      <label>×§×•×“ ×’×™×©×”:</label>
      <input type="password" id="accessCodeInput" placeholder="×”×–×Ÿ ×§×•×“ ×’×™×©×”">
    </div>

    <button class="login-btn" id="loginBtn">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
    <div class="error-msg" id="errorMsg">×§×•×“ ×’×™×©×” ×©×’×•×™</div>
  </div>

  <!-- Main App Container -->
  <div class="container" id="appContainer">
    <h1>ğŸ€ ×§××¨×¤×•×œ ×›×“×•×¨×¡×œ <span id="userName" style="font-size:9px; color:#666;"></span> <button onclick="logout()" style="float:left; padding:3px 8px; font-size:8px; border:none; background:#999; color:white; border-radius:3px; cursor:pointer;">×”×—×œ×£</button></h1>
    
    <div class="legend">
      <div class="legend-item">
        <div class="color-dot blue"></div>
        <span>×›×—×•×œ=××•×¨×™</span>
      </div>
      <div class="legend-item">
        <div class="color-dot green"></div>
        <span>×™×¨×•×§=× ×•×¢×</span>
      </div>
      <div class="legend-item">
        <div class="color-dot orange"></div>
        <span>×›×ª×•×=×ª××™×¨</span>
      </div>
      <div class="legend-item">
        <div class="color-dot red"></div>
        <span>××“×•×=×¢×“×™</span>
      </div>
    </div>
    
    <div class="week-nav">
      <button onclick="changeWeek(-1)">â—„ ×§×•×“×</button>
      <span class="week-title" id="weekTitle">×˜×•×¢×Ÿ...</span>
      <button onclick="changeWeek(1)">×”×‘× â–º</button>
    </div>
    
    <table class="schedule-table">
      <thead>
        <tr id="dateHeaders"></tr>
      </thead>
      <tbody id="scheduleBody"></tbody>
    </table>
    
    <div class="requests-section">
      <div class="requests-title">×‘×§×©×•×ª ×•××™×œ×•×¦×™×</div>
      <div id="requestsList"></div>
      <button class="add-request-btn" onclick="addRequest()">+ ×”×•×¡×£ ×‘×§×©×”</button>
    </div>
    
    <div class="upload-area">
      <label for="imageUpload" class="upload-label">ğŸ“· ×”×¢×œ×” ×ª××•× ×ª ×¡×™×“×•×¨</label>
      <input type="file" id="imageUpload" accept="image/*">
      <div class="file-name" id="fileName"></div>
      <img id="imagePreview" class="image-preview" alt="×ª××•× ×ª ×¡×™×“×•×¨">
    </div>
    
    <div class="approval-section">
      <div class="approval-title">××™×©×•×¨ ×¡×™×“×•×¨</div>
      <div class="approval-buttons">
        <button class="approve-btn blue" id="approve-blue" onclick="toggleApproval('blue')">
          <span class="check-mark">âœ“</span> ××•×¨×™
        </button>
        <button class="approve-btn green" id="approve-green" onclick="toggleApproval('green')">
          <span class="check-mark">âœ“</span> × ×•×¢×
        </button>
        <button class="approve-btn orange" id="approve-orange" onclick="toggleApproval('orange')">
          <span class="check-mark">âœ“</span> ×ª××™×¨
        </button>
        <button class="approve-btn red" id="approve-red" onclick="toggleApproval('red')">
          <span class="check-mark">âœ“</span> ×¢×“×™
        </button>
      </div>
      <div class="lock-status" id="lockStatus"></div>
    </div>
  </div>

  <script>
    const DAYS = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday'];
    const DAY_NAMES = ['××³', '×‘×³', '×’×³', '×“×³', '×”×³'];
    const DIRECTIONS = [
      { key: 'out', label: '×”×œ×•×š' },
      { key: 'return', label: '×—×–×•×¨' }
    ];
    
    const COLORS = [
      { value: '', label: '---', class: '' },
      { value: 'blue', label: '××•×¨×™', class: 'blue' },
      { value: 'green', label: '× ×•×¢×', class: 'green' },
      { value: 'orange', label: '×ª××™×¨', class: 'orange' },
      { value: 'red', label: '×¢×“×™', class: 'red' }
    ];
    
    const TIMES = [];
    for (let hour = 15; hour <= 21; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 21 && minute > 30) break;
        TIMES.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
      }
    }
    
    let scheduleData = {};
    let currentWeekOffset = 0;
    let requests = [];
    let approvals = { blue: false, green: false, orange: false, red: false };
    let isLocked = false;
    let currentUser = null;
    
    // This will be set from the server
    const API_URL = "https://basketball-carpool-backend-246561042500.me-west1.run.app";
    
    function init() {
      // Check for saved user
      const savedUser = localStorage.getItem('carpool_user');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showApp();
      }
      
      // Login screen events
      const loginBtn = document.getElementById('loginBtn');
      const accessCodeInput = document.getElementById('accessCodeInput');
      
      accessCodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
      });
      
      loginBtn.addEventListener('click', handleLogin);
    }
    
    async function handleLogin() {
      const accessCode = document.getElementById('accessCodeInput').value.trim();
      const errorMsg = document.getElementById('errorMsg');
      
      if (!accessCode) {
        errorMsg.textContent = '× × ×œ×”×–×™×Ÿ ×§×•×“ ×’×™×©×”';
        errorMsg.classList.add('show');
        return;
      }
      
      // Verify access code with server
      try {
        const response = await fetch(API_URL + '/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': accessCode
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          currentUser = { 
            accessCode: accessCode,
            role: 'user'
          };
          localStorage.setItem('carpool_user', JSON.stringify(currentUser));
          showApp();
        } else {
          errorMsg.textContent = '×§×•×“ ×’×™×©×” ×©×’×•×™';
          errorMsg.classList.add('show');
        }
      } catch (error) {
        console.error('Login error:', error);
        errorMsg.textContent = '×©×’×™××ª ×ª×§×©×•×¨×ª';
        errorMsg.classList.add('show');
      }
    }
    
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appContainer').classList.add('active');
      document.getElementById('userName').textContent = '';
      
      loadFromLocalStorage();
      updateWeekDisplay();
      renderSchedule();
      renderRequests();
      renderApprovals();
      checkLockStatus();
      
      const imageUpload = document.getElementById('imageUpload');
      const imagePreview = document.getElementById('imagePreview');
      
      imageUpload.addEventListener('change', handleImageUpload);
      imagePreview.addEventListener('click', function() {
        this.classList.toggle('zoomed');
      });
    }
    
    function logout() {
      localStorage.removeItem('carpool_user');
      currentUser = null;
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('appContainer').classList.remove('active');
      document.getElementById('accessCodeInput').value = '';
      document.getElementById('errorMsg').classList.remove('show');
    }
    
    function getWeekDates(offset) {
      const today = new Date();
      const sunday = new Date(today);
      sunday.setDate(today.getDate() - today.getDay() + (offset * 7));
      
      const dates = [];
      for (let i = 0; i < 5; i++) {
        const d = new Date(sunday);
        d.setDate(sunday.getDate() + i);
        dates.push(d);
      }
      return dates;
    }
    
    function getWeekKey(offset) {
      const dates = getWeekDates(offset);
      return `${dates[0].getFullYear()}-${dates[0].getMonth() + 1}-${dates[0].getDate()}`;
    }
    
    function formatDate(d) {
      return `${d.getDate()}/${d.getMonth() + 1}`;
    }
    
    function updateWeekDisplay() {
      const dates = getWeekDates(currentWeekOffset);
      const start = formatDate(dates[0]);
      const end = formatDate(dates[4]);
      document.getElementById('weekTitle').textContent = `${start} - ${end}`;
      
      const dateHeaders = document.getElementById('dateHeaders');
      dateHeaders.innerHTML = '<th></th>';
      dates.forEach((date, i) => {
        const th = document.createElement('th');
        th.innerHTML = `${DAY_NAMES[i]}<br><span class="day-header">${formatDate(date)}</span>`;
        dateHeaders.appendChild(th);
      });
    }
    
    function changeWeek(direction) {
      currentWeekOffset += direction;
      updateWeekDisplay();
      loadWeekData();
      renderSchedule();
      renderRequests();
      renderApprovals();
      checkLockStatus();
    }
    
    function renderSchedule() {
      const tbody = document.getElementById('scheduleBody');
      tbody.innerHTML = '';
      
      DIRECTIONS.forEach(direction => {
        const tr = document.createElement('tr');
        
        const tdDir = document.createElement('td');
        tdDir.className = 'direction-cell';
        tdDir.textContent = direction.label;
        tr.appendChild(tdDir);
        
        DAYS.forEach(day => {
          const td = document.createElement('td');
          td.innerHTML = `
            <div class="trip-controls">
              ${createColorSelect(direction.key, day)}
              ${createTimeSelect(direction.key, day)}
            </div>
          `;
          tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
      });
      
      const notesRow = document.createElement('tr');
      notesRow.className = 'notes-row';
      const tdLabel = document.createElement('td');
      tdLabel.className = 'direction-cell';
      tdLabel.textContent = '×”×¢×¨×•×ª';
      notesRow.appendChild(tdLabel);
      
      DAYS.forEach((day) => {
        const td = document.createElement('td');
        const savedNote = scheduleData.notes?.[day] || '';
        td.innerHTML = `<textarea class="note-input" data-day="${day}" rows="2" placeholder="×”×¢×¨×”...">${savedNote}</textarea>`;
        notesRow.appendChild(td);
      });
      
      tbody.appendChild(notesRow);
      
      document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', handleChange);
      });
      
      document.querySelectorAll('.note-input').forEach(textarea => {
        textarea.addEventListener('input', handleNoteChange);
      });
    }
    
    function createColorSelect(direction, day) {
      const savedColor = scheduleData[direction]?.[day]?.color || '';
      let html = `<select class="color-select ${savedColor}" data-direction="${direction}" data-day="${day}" data-type="color">`;
      COLORS.forEach(color => {
        html += `<option value="${color.value}" ${color.value === savedColor ? 'selected' : ''}>${color.label}</option>`;
      });
      html += '</select>';
      return html;
    }
    
    function createTimeSelect(direction, day) {
      const savedTime = scheduleData[direction]?.[day]?.time || '';
      let html = `<select class="time-select" data-direction="${direction}" data-day="${day}" data-type="time">`;
      html += '<option value="">--:--</option>';
      TIMES.forEach(time => {
        html += `<option value="${time}" ${time === savedTime ? 'selected' : ''}>${time}</option>`;
      });
      html += '</select>';
      return html;
    }
    
    function handleChange(e) {
      const select = e.target;
      const direction = select.dataset.direction;
      const day = select.dataset.day;
      const type = select.dataset.type;
      const value = select.value;
      
      if (!scheduleData[direction]) scheduleData[direction] = {};
      if (!scheduleData[direction][day]) scheduleData[direction][day] = {};
      
      scheduleData[direction][day][type] = value;
      
      if (type === 'color') {
        select.className = `color-select ${value}`;
      }
      
      saveToLocalStorage();
    }
    
    function handleNoteChange(e) {
      const textarea = e.target;
      const day = textarea.dataset.day;
      
      if (!scheduleData.notes) scheduleData.notes = {};
      scheduleData.notes[day] = textarea.value;
      
      saveToLocalStorage();
    }
    
    function addRequest() {
      requests.push({ child: '', text: '' });
      renderRequests();
    }
    
    function removeRequest(index) {
      requests.splice(index, 1);
      renderRequests();
      saveToLocalStorage();
    }
    
    function renderRequests() {
      const container = document.getElementById('requestsList');
      container.innerHTML = '';
      
      requests.forEach((req, index) => {
        const div = document.createElement('div');
        div.className = 'request-item';
        div.innerHTML = `
          <select class="${req.child}" onchange="updateRequestChild(${index}, this.value)">
            ${COLORS.map(c => `<option value="${c.value}" ${c.value === req.child ? 'selected' : ''}>${c.label}</option>`).join('')}
          </select>
          <textarea rows="1" placeholder="×œ×“×•×’××”: ××¢×“×™×£ ×‘×™×•× ×’×³" oninput="updateRequestText(${index}, this.value)">${req.text}</textarea>
          <button class="remove-request-btn" onclick="removeRequest(${index})">Ã—</button>
        `;
        container.appendChild(div);
      });
    }
    
    function updateRequestChild(index, value) {
      requests[index].child = value;
      renderRequests();
      saveToLocalStorage();
    }
    
    function updateRequestText(index, value) {
      requests[index].text = value;
      saveToLocalStorage();
    }
    
    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      document.getElementById('fileName').textContent = `âœ“ ${file.name}`;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = document.getElementById('imagePreview');
        img.src = event.target.result;
        img.classList.add('show');
      };
      reader.readAsDataURL(file);
    }
    
    function saveToLocalStorage() {
      const weekKey = getWeekKey(currentWeekOffset);
      const allData = JSON.parse(localStorage.getItem('carpoolAllWeeks') || '{}');
      allData[weekKey] = { 
        schedule: scheduleData, 
        requests: requests,
        approvals: approvals,
        locked: isLocked
      };
      localStorage.setItem('carpoolAllWeeks', JSON.stringify(allData));
      
      // Also save to server (Google Sheets)
      saveToServer(weekKey);
    }
    
    async function saveToServer(weekKey) {
      if (!currentUser || !currentUser.accessCode) return;
      
      try {
        const weekData = {
          schedule: scheduleData,
          requests: requests,
          approvals: approvals,
          locked: isLocked
        };
        
        const response = await fetch(API_URL + '?action=save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': currentUser.accessCode
          },
          body: JSON.stringify({
            weekKey: weekKey,
            weekData: weekData
          })
        });
        
        const result = await response.json();
        if (!result.success) {
          console.error('Save to server failed:', result.error);
        }
      } catch (error) {
        console.error('Error saving to server:', error);
      }
    }
    
    function loadFromLocalStorage() {
      const allData = JSON.parse(localStorage.getItem('carpoolAllWeeks') || '{}');
      const weekKey = getWeekKey(currentWeekOffset);
      const weekData = allData[weekKey] || {};
      scheduleData = weekData.schedule || {};
      requests = weekData.requests || [];
      approvals = weekData.approvals || { blue: false, green: false, orange: false, red: false };
      isLocked = weekData.locked || false;
      
      // Also load from server
      loadFromServer(weekKey);
    }
    
    async function loadFromServer(weekKey) {
      if (!currentUser || !currentUser.accessCode) return;
      
      try {
        const response = await fetch(API_URL + `?action=load&weekKey=${weekKey}`, {
          method: 'GET',
          headers: {
            'X-API-Key': currentUser.accessCode
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.weekData) {
          const serverData = result.weekData;
          
          // Update with server data (server is source of truth)
          scheduleData = serverData.schedule || {};
          requests = serverData.requests || [];
          approvals = serverData.approvals || { blue: false, green: false, orange: false, red: false };
          isLocked = serverData.locked || false;
          
          // Also save to localStorage as cache
          const allData = JSON.parse(localStorage.getItem('carpoolAllWeeks') || '{}');
          allData[weekKey] = serverData;
          localStorage.setItem('carpoolAllWeeks', JSON.stringify(allData));
          
          // Re-render with server data
          renderSchedule();
          renderRequests();
          renderApprovals();
          checkLockStatus();
        }
      } catch (error) {
        console.error('Error loading from server:', error);
        // Fall back to localStorage if server fails
      }
    }
    
    function loadWeekData() {
      loadFromLocalStorage();
    }
    
    function toggleApproval(color) {
      if (isLocked) {
        alert('ğŸ”’ ×”×¡×™×“×•×¨ × ×¢×•×œ! ×›×‘×¨ ×›×•×œ× ××™×©×¨×•.');
        return;
      }
      
      approvals[color] = !approvals[color];
      renderApprovals();
      checkLockStatus();
      saveToLocalStorage();
    }
    
    function renderApprovals() {
      ['blue', 'green', 'orange', 'red'].forEach(color => {
        const btn = document.getElementById(`approve-${color}`);
        if (approvals[color]) {
          btn.classList.add('approved');
        } else {
          btn.classList.remove('approved');
        }
      });
    }
    
    function checkLockStatus() {
      const allApproved = Object.values(approvals).every(val => val === true);
      isLocked = allApproved;
      
      const lockStatus = document.getElementById('lockStatus');
      if (isLocked) {
        lockStatus.textContent = 'ğŸ”’ ×”×¡×™×“×•×¨ × ×¢×•×œ - ×›×•×œ× ××™×©×¨×•!';
        lockStatus.className = 'lock-status locked';
        disableInputs();
      } else {
        const approved = Object.values(approvals).filter(v => v).length;
        lockStatus.textContent = `××•×©×¨ ×¢×œ ×™×“×™ ${approved}/4 ×”×•×¨×™×`;
        lockStatus.className = 'lock-status';
        enableInputs();
      }
    }
    
    function disableInputs() {
      // When locked, no one can edit
      document.querySelectorAll('.schedule-table select, .schedule-table textarea').forEach(el => {
        el.disabled = true;
        el.style.pointerEvents = 'none';
      });
    }
    
    function enableInputs() {
      document.querySelectorAll('.schedule-table select, .schedule-table textarea').forEach(el => {
        el.disabled = false;
        el.style.pointerEvents = 'auto';
      });
    }
    
    function saveSchedule() {
      saveToLocalStorage();
      alert('âœ… ×”×¡×™×“×•×¨ × ×©××¨!');
    }
    
    function clearAll() {
      if (isLocked) {
        alert('ğŸ”’ ×”×¡×™×“×•×¨ × ×¢×•×œ! ×œ× × ×™×ª×Ÿ ×œ× ×§×•×ª.');
        return;
      }
      
      if (confirm('×œ××—×•×§ ××ª ×”×¡×™×“×•×¨ ×©×œ ×”×©×‘×•×¢ ×”×–×”?')) {
        scheduleData = {};
        requests = [];
        approvals = { blue: false, green: false, orange: false, red: false };
        isLocked = false;
        saveToLocalStorage();
        renderSchedule();
        renderRequests();
        renderApprovals();
        checkLockStatus();
        document.getElementById('fileName').textContent = '';
        document.getElementById('imageUpload').value = '';
        document.getElementById('imagePreview').classList.remove('show');
        document.getElementById('imagePreview').src = '';
      }
    }
    
    init();
  </script>
</body>
</html>
